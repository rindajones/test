## 姿勢推定に向けたセグメンテーションモデル構築状況報告
**キーポイントモデルからの転換と進捗報告**

### 0. 前回まで
サイドスラスターを「コーン」に見立て、姿勢推進のためのキーポイント（９点）を設定した学習データを作成後、YOLOv5モデル（物体検知モデル）のニューラルネットワくをキーポイント推定モデルに改造して学習。

**学習データ**

<img src='./images/train_data.png' width=500>

**結果：失敗**

200件のデータを５時間学習させるも、学習の傾向が見られなかった。ニューラルネットワークの構造に問題はないが、キーポイントに対する「**学習のさせ方**」に問題ありと判断。

<div style="page-break-before:always"></div>

---

### 1. セグメンテーションモデル

キーポイントと同様に姿勢推定の情報を得られる **セグメンテーションモデル** へ切り替え。

**セグメンテーションモデルとは**

画像中の各画素を部品カテゴリに分類するモデル。

<img src='./images/segmentation.png' width=500>

**学習データ**

<table>
<tr>
<td><img src='./images/02.png' width=200></td>
<td><img src='./images/02_mask.png' width=200></td>
</tr>
<tr>
<td><img src='./images/01.png' width=200></td>
<td><img src='./images/01_mask.png' width=200></td>
</tr>
</table>

---
<div style="page-break-before:always"></div>

### 2. 現在

400枚のデータで学習中。

<img src='./images/train_batch0.jpg' width=300>


#### なぜセグメンテーションを採用しなかったか

- **学習データの作成が困難**
  
　対応方法：３日間かけて、セグメンテーション学習データを自動作成するプログラムを作成

　**⚠️ ただし** 作成に要する時間１枚あたり３０秒以上（400件の場合 **３時間半**）

- **学習（モデル構築）に時間を要する**

　**３年前の同様の開発** データ1,200枚以上で「CPUの場合は約**２０時間**」「GPUの場合は約**４時間**」

- **ラズパイで動かせるサイズにできる見込み**

　現在は **YOLOv5s-seg**、可能であれば **YOLOv5n-seg**

<img src='./images/size.png' width=500>


#### 学習の見込み

キーポイントモデルのようにYOLOv5の改造は必要とせず、YOLOの流儀に従った「再学習」（**fine tuning**）を実施するため、データの量と質の工夫で確実に学習可能。

<div style="page-break-before:always"></div>

---

### 3. 過去の事例

３年前の「某大手ハウスメーカー向け高力ボルトの **締め付け角度推定**」で、セグメンテーションモデルを使用。

<img src='./images/bolt.png'>

----

学習状況：7月22日16:00

mAP50などの学習評価値が **初めて表示**、つまり**学習している証**。

```
...
13/49         0G    0.05222     0.0398     0.0586    0.03851         73       1024:  90%|█████████ | 36/40 [08:20<00:56, 14.08s/it]
13/49         0G    0.05209    0.03974    0.05837    0.03843         86       1024:  92%|█████████▎| 37/40 [08:34<00:42, 14.03s/it]
13/49         0G    0.05207    0.04005     0.0586    0.03837        107       1024:  95%|█████████▌| 38/40 [08:48<00:27, 13.98s/it]
13/49         0G    0.05197    0.03996    0.05835    0.03844         86       1024:  98%|█████████▊| 39/40 [09:01<00:13, 13.75s/it]
13/49         0G    0.05206    0.04019    0.05809    0.03857         83       1024: 100%|██████████| 40/40 [09:16<00:00, 13.91s/it]

Class     Images  Instances      Box(P          R      mAP50  mAP50-95)     Mask(P          R      mAP50  mAP50-95): 100%|████████
all         80        545      0.632       0.69      0.688      0.295    0.00218    0.00176   0.000103   1.03e-05
...
```